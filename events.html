<!DOCTYPE html>
<html lang="en" data-theme="light" class="no-js">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <title>
      Events & Campus Programs ‚Äì Rijo John | Quizzes, Talks & Workshops
    </title>

    <meta
      name="description"
      content="Browse upcoming and past campus quizzes, guest lectures, workshops and training sessions by Rijo John in Kerala and beyond. Filter events, search topics and add programmes to your calendar."
    />
    <meta
      name="keywords"
      content="Rijo John events, campus quiz master Kerala, workshops, guest lecture, faculty development, media literacy training, research methodology workshop, motivational talk, travel storytelling"
    />
    <meta name="author" content="Rijo John Sankarathil" />
    <meta name="robots" content="index,follow" />
    <meta name="theme-color" content="#0ea5e9" />
    <link
      rel="canonical"
      href="https://rijojohn.netlify.app/events.html"
    />

    <!-- Netlify metatag-->
   <meta name="google-site-verification" content="fBxQcDTnB5Qdr6exM9eWxh8cOqlA4CUwRQpp7swCU28" />
   <meta name="msvalidate.01" content="B45DB9E0F5A6C3427B7C3E10CA32EB35" />

   <!-- Gthub metatag-->
  <meta name="google-site-verification" content="a6PlDsRAdHgeCQfGMplxia-yuZ04Ojn2wTdNMcaljmI" />
  <meta name="msvalidate.01" content="B45DB9E0F5A6C3427B7C3E10CA32EB35" />
  
    <!-- Open Graph / Facebook -->
    <meta
      property="og:title"
      content="Events & Campus Programs ‚Äì Rijo John"
    />
    <meta
      property="og:description"
      content="Upcoming and past quizzes, guest lectures, workshops and training sessions led by educator and quiz master Rijo John. Explore events and add upcoming programmes to your calendar."
    />
    <meta
      property="og:image"
      content="https://rijojohn.netlify.app/assets/img/icon.jpg"
    />
    <meta
      property="og:image:alt"
      content="Rijo John speaking at an event"
    />
    <meta
      property="og:url"
      content="https://rijojohn.netlify.app/events.html"
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:site_name"
      content="Rijo John ‚Äî Traveller, Educator & Author"
    />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content="Events & Campus Programs ‚Äì Rijo John"
    />
    <meta
      name="twitter:description"
      content="Explore quizzes, workshops, guest lectures and training sessions by Rijo John and add upcoming events to your calendar."
    />
    <meta
      name="twitter:image"
      content="https://rijojohn.netlify.app/assets/img/icon.jpg"
    />

    <!-- Icons  -->
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./favicon.png"
    />
    <link rel="icon" href="./favicon.png" type="image/png" sizes="512x512" />
    <link rel="shortcut icon" href="./favicon.png" />
    <link rel="apple-touch-icon" href="./favicon.png" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Shared site styles -->
    <link rel="stylesheet" href="./css/style.css" />

    <script>
      document.documentElement.classList.remove('no-js');
    </script>
  </head>

  <body class="site-body">
    <a href="#main" class="skip-link">Skip to content</a>

    <!-- Header / Nav (keep classes to match your CSS) -->
    <header class="site-header" id="top">
      <nav class="nav" aria-label="Primary navigation">
        <div class="container nav__inner">
          <!-- Brand -->
          <a href="./index.html" class="nav__brand">
            <span class="nav__brand-main">Rijo John</span>
            <span class="nav__brand-tagline">Traveller ‚Ä¢ Educator ‚Ä¢ Author</span>
          </a>

          <!-- Desktop Links -->
          <div class="nav__links" id="primaryNav">
            <a href="./index.html" class="nav__link">
              Home
            </a>
            <a href="./about.html" class="nav__link">
              About
            </a>
            <a
              href="./books.html"
              class="nav__link">
              Books
            </a>
            <a href="./youtube.html" class="nav__link">YouTube</a>
            <a href="./events.html" class="nav__link nav__link--active" aria-current="page">Events</a>
            <a href="./map.html" class="nav__link">Travel Map</a>
            <a href="./contact.html" class="nav__link">Contact</a>
          </div>

          <!-- Right side controls -->
          <div class="nav__controls">
            <!-- Theme toggle -->
            <button
              type="button"
              class="theme-toggle"
              id="themeToggle"
              aria-label="Toggle dark mode"
              aria-pressed="false"
            >
              <span
                class="theme-toggle__icon theme-toggle__icon--sun"
                aria-hidden="true"
              >
                <svg viewBox="0 0 24 24" class="theme-toggle__svg">
                  <path
                    d="M12 4V2m0 20v-2m8-8h2M2 12h2m13.657-7.071L18.364 6.22M5.636 17.778L4.222 19.192m0-14.97L5.636 6.22m12.728 11.557 1.414 1.414M16 12a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.7"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </span>
              <span
                class="theme-toggle__icon theme-toggle__icon--moon"
                aria-hidden="true"
              >
                <svg viewBox="0 0 24 24" class="theme-toggle__svg">
                  <path
                    d="M21 12.79A9 9 0 0 1 11.21 3 7 7 0 1 0 21 12.79Z"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.7"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </span>
            </button>

            <!-- Mobile menu button -->
            <button
              type="button"
              class="nav__toggle"
              id="navToggle"
              aria-label="Open main menu"
              aria-expanded="false"
              aria-controls="primaryNav"
            >
              <span class="nav__toggle-line"></span>
              <span class="nav__toggle-line"></span>
              <span class="nav__toggle-line"></span>
            </button>
          </div>
        </div>
      </nav>
    </header>

    <main id="main" class="site-main">
      <!-- intro -->
      <section class="section section--page-intro section--events-intro" aria-labelledby="events-title">
        <div class="container grid grid--split">
          <div class="section__col">
            <p class="section__eyebrow">Programs & campuses</p>
            <h1 id="events-title" class="page-title">Events, workshops & learning journeys</h1>
            <p class="section__lead">
              From <strong>quiz stages</strong> to
              <strong>orientation halls</strong>, these programs are designed
              to make <strong>learning interactive, visual and memorable</strong>
              for students, teachers and communities.
            </p>

            <p class="section__body">
              Explore <strong>upcoming sessions</strong>, browse
              <strong>past highlights</strong>, and plan the next event for
              your college, school or organisation.
            </p>

            <div class="section__cta-row">
              <a href="./contact.html" class="btn btn--primary">Invite for a session</a>
              <a href="#events-list" class="btn btn--ghost">View event schedule</a>
            </div>
          </div>

          <aside class="section__col events-intro-card" aria-label="Event formats summary">
            <div class="events-intro-card__inner">
              <p class="events-intro-card__label">At a glance</p>
              <ul class="events-intro-card__list">
                <li>
                  <span class="events-intro-card__pill">üéØ Quizzes</span>
                  <span class="events-intro-card__text">
                    Inter-collegiate &amp; school-level general knowledge and
                    themed quizzes.
                  </span>
                </li>
                <li>
                  <span class="events-intro-card__pill">üéô Talks</span>
                  <span class="events-intro-card__text">
                    Motivational sessions, travel storytelling and book-related
                    interactions.
                  </span>
                </li>
                <li>
                  <span class="events-intro-card__pill">üìö FDP &amp; training</span>
                  <span class="events-intro-card__text">
                    Orientation programs, communication skills and faculty
                    development workshops.
                  </span>
                </li>
              </ul>
              <p class="events-intro-card__footer"><strong>200+ events</strong> hosted across campuses and cultural fests in Kerala.</p>
            </div>
          </aside>
        </div>
      </section>

      <!-- EVENT FORMATS / TYPES -->
      <section
        class="section section--events-formats"
        aria-labelledby="formats-heading"
      >
        <div class="container">
          <header class="section__header section__header--center">
            <p class="section__eyebrow">Formats offered</p>
            <h2 id="formats-heading" class="section__title">
              What kind of events can you plan?
            </h2>
            <p class="section__lead">
              Mix and match formats based on your audience ‚Äî from competitive
              quizzes to reflective travel talks and interactive training
              sessions.
            </p>
          </header>

          <div class="grid grid--cards">
            <article class="card card--role">
              <div class="card__icon-wrap card__icon-wrap--green">
                <span class="card__icon" aria-hidden="true">üéØ</span>
              </div>
              <h3 class="card__title">Campus quiz events</h3>
              <p class="card__body">
                General knowledge and theme-based quizzes for schools,
                colleges and fests, designed to be
                <strong>competitive yet fun</strong>.
              </p>
            </article>

            <article class="card card--role">
              <div class="card__icon-wrap card__icon-wrap--amber">
                <span class="card__icon" aria-hidden="true">üéô</span>
              </div>
              <h3 class="card__title">Motivational &amp; career talks</h3>
              <p class="card__body">
                Sessions on <strong>mindset, confidence, communication</strong>
                and real-world orientation for students and young
                professionals.
              </p>
            </article>

            <article class="card card--role">
              <div class="card__icon-wrap card__icon-wrap--blue">
                <span class="card__icon" aria-hidden="true">üß≠</span>
              </div>
              <h3 class="card__title">Travel storytelling</h3>
              <p class="card__body">
                Visual journeys using <strong>travel experiences</strong> to
                talk about culture, empathy, language and learning through
                exploration.
              </p>
            </article>

            <article class="card card--role">
              <div class="card__icon-wrap card__icon-wrap--purple">
                <span class="card__icon" aria-hidden="true">üìö</span>
              </div>
              <h3 class="card__title">Workshops &amp; FDP</h3>
              <p class="card__body">
                Practical <strong>skill-building workshops</strong>,
                including soft skills, classroom engagement and faculty
                development programs.
              </p>
            </article>
          </div>
        </div>
      </section>

      <!-- EVENTS LIST / FILTERS + GRID -->
            
      <section class="section section--events-list" id="events-list" aria-labelledby="events-list-heading">
        <div class="container">
          <header class="section__header section__header--center">
            <p class="section__eyebrow">Schedule</p>
            <h2 id="events-list-heading" class="section__title">Upcoming programs &amp; past highlights</h2>
            <p class="section__lead">Filter, search and add upcoming events to your calendar.</p>
          </header>

          <!-- Controls: filters + search -->
          <div class="events-controls" role="toolbar" aria-label="Event filters and search">
            <div role="group" aria-label="Event type filters" class="events-controls__filters">
              <button class="filter-btn filter-btn--status" data-filter="all" aria-pressed="true">All</button>
              <button class="filter-btn filter-btn--status" data-filter="upcoming" aria-pressed="false">Upcoming</button>
              <button class="filter-btn" data-filter="workshop" aria-pressed="false">Workshops</button>
              <button class="filter-btn" data-filter="conference" aria-pressed="false">Conferences</button>
              <button class="filter-btn" data-filter="guest-lecture" aria-pressed="false">Guest lectures</button>
              <button class="filter-btn" data-filter="training" aria-pressed="false">Training</button>
            </div>

            <div class="search" role="search" aria-label="Search events">
              <label for="eventsSearch" class="sr-only">Search events</label>
              <input
                id="eventsSearch"
                type="search"
                placeholder="Search events, topics or location"
                aria-label="Search events"
              />
            </div>
          </div>

          <div class="events-shell" aria-live="polite">
            <div id="eventsContainer" class="events-grid" aria-busy="true">
              <div class="events-loader text-center py-12">
                <div class="animate-spin events-loader__spinner" aria-hidden="true"></div>
                <p class="events-loader__text">Loading events‚Ä¶</p>
              </div>
            </div>
          </div>

          <!-- Extra descriptive SEO/accessible copy -->
          <div class="events-context">
            <p class="events-context__text">
              Every event is designed to promote
              <strong>creative learning, general knowledge, communication
              skills and cultural awareness</strong>. Whether it is a quiz, a
              travel talk or a motivational session, the focus is on
              <strong>real-world education through stories, interaction and
              humour</strong>.
            </p>
          </div>
        </div>
      </section>


      <section
        class="section section--events-cta"
        aria-labelledby="events-cta-heading"
      >
        <div class="container section--cta__inner">
          <div>
            <p class="section__eyebrow">Plan an event</p>
            <h2 id="events-cta-heading" class="section__title">
              Bring an engaging session to your campus
            </h2>
            <p class="section__lead">
              Looking for a <strong>quiz master</strong>,
              <strong>motivational speaker</strong> or
              <strong>travel storyteller</strong>? Let‚Äôs design a program that
              fits your students and institution.
            </p>
          </div>
          <div class="section--cta__actions">
            <a href="./contact.html" class="btn btn--primary">
              Enquire now
            </a>
            <a href="./about.html" class="btn btn--ghost">
              Learn more about Rijo
            </a>
          </div>
        </div>
      </section>

    </main>

    <!-- FOOTER -->
    <footer class="site-footer">
      <div class="container site-footer__inner">
        <div class="site-footer__main">
          <div class="site-footer__brand">
            <h3 class="site-footer__title">Rijo John Sankarathil</h3>
            <p class="site-footer__subtitle">
              Traveller ‚Ä¢ Author ‚Ä¢ Vlogger ‚Ä¢ Quiz Master ‚Ä¢ Orator
            </p>

            <div
              class="site-footer__social"
              aria-label="Social links"
            >
              <a
                href="https://www.youtube.com/@JOURNEYSOFJO/"
                class="social-link"
                aria-label="YouTube"
                target="_blank"
                rel="noopener noreferrer"
              >
                <svg
                  class="social-link__icon"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path
                    d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"
                  />
                </svg>
              </a>

              <a
                href="https://www.instagram.com/_journeys_of_jo_/"
                class="social-link"
                aria-label="Instagram"
                target="_blank"
                rel="noopener noreferrer"
              >
                <svg class="social-link__icon" viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"
                />
              </svg>
              </a>
                      <!-- Facebook -->
              <a
                href="https://www.facebook.com/jojfb"
                class="social-link"
                aria-label="Facebook"
                target="_blank"
                rel="noopener noreferrer"
              >
                <svg class="social-link__icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    d="M22 12.07C22 6.48 17.52 2 11.93 2 6.35 2 1.87 6.48 1.87 12.07 1.87 17.11 5.66 21.24 10.44 22v-6.99H7.9v-2.94h2.54v-2.24c0-2.5 1.49-3.88 3.77-3.88 1.09 0 2.23.2 2.23.2v2.45h-1.26c-1.24 0-1.63.77-1.63 1.56v1.91h2.78l-.44 2.94h-2.34V22c4.78-.76 8.57-4.89 8.57-9.93Z"
                  />
                </svg>
              </a>
            </div>
          </div>

          <div class="site-footer__links">
            <div class="site-footer__column">
              <h4 class="site-footer__heading">Quick links</h4>
              <ul>
                <li><a href="./about.html" class="footer-link">About</a></li>
                <li><a href="./books.html" class="footer-link">Books</a></li>
                <li><a href="./youtube.html" class="footer-link">YouTube</a></li>
              </ul>
            </div>

            <div class="site-footer__column">
              <h4 class="site-footer__heading">Explore</h4>
              <ul>
                <li><a href="./events.html" class="footer-link">Events</a></li>
                <li><a href="./map.html" class="footer-link">Travel map</a></li>
                <li><a href="./contact.html" class="footer-link">Contact</a></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="site-footer__bottom">
          <p class="site-footer__copy">
            &copy; 2024 Rijo John ‚Äî Traveller, Educator &amp; Author from
            Kerala.
          </p>

          <p class="designer-signature">
            <span class="designer-signature-label">Crafted by</span>
            <a
              href="#"
              target="_blank"
              rel="noopener noreferrer"
              class="designer-signature-name"
            >
              Reebu.AB
            </a>
          </p>
        </div>
      </div>
    </footer>

    <div
  id="posterModal"
  class="poster-modal"
  aria-hidden="true"
>
  <div
    class="poster-modal__backdrop"
    onclick="closePosterModal()"
  ></div>

  <div
    class="poster-modal__dialog"
    role="dialog"
    aria-modal="true"
    aria-labelledby="posterModalTitle"
  >
    <button
      type="button"
      class="poster-modal__close"
      aria-label="Close poster"
      onclick="closePosterModal()"
    >
      √ó
    </button>
    <img
      class="poster-modal__img"
      src=""
      alt=""
      loading="lazy"
    />
    <p
      id="posterModalTitle"
      class="poster-modal__caption"
    ></p>
  </div>
</div>



    <script>
      // ============================================================================
// ENHANCED EVENTS SYSTEM v2.0
// Fully time-aware, auto-refreshing
// ============================================================================

(function () {
  'use strict';

  // ========== CONFIGURATION ==========
  const CONFIG = {
    eventsPath: './data/events.json',
    refreshInterval: 30000, // 30 seconds
    notificationLeadTime: 15 * 60 * 1000, // 15 minutes in ms
    startingSoonWindow: 30 * 60 * 1000, // 30 minutes
    ongoingDuration: 60 * 60 * 1000, // 1 hour default
  };

  // ========== STATE ==========
  let allEvents = [];
  let activeFilter = 'all';
  let nearestUpcomingKey = null;
  let notifiedEvents = new Set(); // Track which events we've already notified
  let refreshTimer = null;

  const STATUS_PRIORITY = {
  ONGOING: 1,
  STARTING_SOON: 2,
  TODAY: 3,
  UPCOMING: 4,
  PAST: 5,
};


  // ========== DOM REFERENCES ==========
  const container = document.getElementById('eventsContainer');
  const searchInput = document.getElementById('eventsSearch');

  // ========== UTILITY FUNCTIONS ==========

  /**
   * Safely parse ISO date string
   */
  function isoDateSafe(d) {
    if (!d) return null;
    const dt = new Date(d);
    return isNaN(dt) ? d : dt.toISOString().split('T')[0];
  }

  /**
   * Format date in friendly format (e.g., "11 Dec, 2025")
   */
  function formatDateFriendly(iso) {
    try {
      const d = new Date(iso);
      if (isNaN(d)) return iso;
      return d.toLocaleDateString('en-GB', {
        day: 'numeric',
        month: 'short',
        year: 'numeric',
      });
    } catch (e) {
      return iso;
    }
  }

  /**
   * Format time in 12-hour format (e.g., "4:30 PM")
   */
  function formatTime12Hour(timeStr) {
    if (!timeStr) return '';
    const [hours, minutes] = timeStr.split(':').map(Number);
    const period = hours >= 12 ? 'PM' : 'AM';
    const displayHours = hours % 12 || 12;
    return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
  }

  /**
   * HTML escape for safe rendering
   */
  function esc(str) {
    return String(str || '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  /**
   * Create stable key for each event
   */
  function makeEventKey(ev) {
    if (ev.id) return String(ev.id);
    const base = ev._iso || ev.date || '';
    const title = ev.title || '';
    return base + '::' + title;
  }

  // ========== EVENT STATUS CALCULATION ==========

  /**
   * Calculate comprehensive event status and metadata
   * Returns: { status, showTime, countdown, statusLabel, statusClass }
   */
  function calculateEventStatus(event) {
    const now = new Date();
    const dateStr = event._iso || event.date || '';
    const eventDate = new Date(dateStr);

    // Invalid date ‚Üí treat as past
    if (isNaN(eventDate)) {
      return {
        status: 'PAST',
        showTime: false,
        countdown: null,
        statusLabel: 'Past',
        statusClass: 'bg-gray-100 text-gray-800',
      };
    }

    // Parse times (default to approximate if missing)
    const startTime = event.startTime || null;
    const endTime = event.endTime || null;
    const dateApprox = event.dateApprox === true;

    // If approximate date, treat as all-day event
    if (dateApprox) {
      const isPast = eventDate < now;
      return {
        status: isPast ? 'PAST' : 'UPCOMING',
        showTime: false,
        countdown: null,
        statusLabel: isPast ? 'Past' : 'Upcoming',
        statusClass: isPast
          ? 'bg-gray-100 text-gray-800'
          : 'bg-green-100 text-green-800',
      };
    }

    // Build full datetime for start and end
    let startDateTime = null;
    let endDateTime = null;

    if (startTime) {
      const [hours, minutes] = startTime.split(':').map(Number);
      startDateTime = new Date(eventDate);
      startDateTime.setHours(hours, minutes, 0, 0);
    } else {
      // No time specified ‚Üí treat as all-day
      startDateTime = new Date(eventDate);
      startDateTime.setHours(0, 0, 0, 0);
    }

    if (endTime && startTime) {
      const [endHours, endMinutes] = endTime.split(':').map(Number);
      endDateTime = new Date(eventDate);
      endDateTime.setHours(endHours, endMinutes, 0, 0);
    } else if (startTime) {
      // Default: 1 hour after start
      endDateTime = new Date(startDateTime.getTime() + CONFIG.ongoingDuration);
    } else {
      // All-day event end
      endDateTime = new Date(eventDate);
      endDateTime.setHours(23, 59, 59, 999);
    }

    // Calculate time differences
    const msUntilStart = startDateTime - now;
    const msUntilEnd = endDateTime - now;

    // Check if same calendar day
    const isSameDay =
      now.getFullYear() === eventDate.getFullYear() &&
      now.getMonth() === eventDate.getMonth() &&
      now.getDate() === eventDate.getDate();

    // ========== STATUS LOGIC ==========

    // PAST: after end time
    if (msUntilEnd < 0) {
      return {
        status: 'PAST',
        showTime: false,
        countdown: null,
        statusLabel: 'Past',
        statusClass: 'bg-gray-100 text-gray-800',
      };
    }

    // ONGOING: between start and end
    if (msUntilStart <= 0 && msUntilEnd > 0) {
      return {
        status: 'ONGOING',
        showTime: true,
        countdown: null,
        statusLabel: 'Ongoing',
        statusClass: 'bg-blue-100 text-blue-800',
      };
    }

    // STARTING SOON: within 45 minutes
    if (isSameDay && msUntilStart > 0 && msUntilStart <= CONFIG.startingSoonWindow) {
      const minutesUntil = Math.ceil(msUntilStart / (60 * 1000));
      return {
        status: 'STARTING_SOON',
        showTime: true,
        countdown: `Starts in ${minutesUntil} min`,
        statusLabel: 'Starting Soon',
        statusClass: 'bg-amber-100 text-amber-800',
      };
    }

    // TODAY: same day but not starting soon yet
    if (isSameDay && msUntilStart > CONFIG.startingSoonWindow) {
      const hoursUntil = Math.floor(msUntilStart / (60 * 60 * 1000));
      const minutesUntil = Math.ceil((msUntilStart % (60 * 60 * 1000)) / (60 * 1000));
      let countdownText = '';
      if (hoursUntil > 0) {
        countdownText = `Starts in ${hoursUntil}h ${minutesUntil}m`;
      } else {
        countdownText = `Starts in ${minutesUntil} min`;
      }
      return {
        status: 'TODAY',
        showTime: true,
        countdown: countdownText,
        statusLabel: 'Today',
        statusClass: 'bg-green-100 text-green-800',
      };
    }

    // UPCOMING: future date
    return {
      status: 'UPCOMING',
      showTime: false,
      countdown: null,
      statusLabel: 'Upcoming',
      statusClass: 'bg-green-100 text-green-800',
    };
  }

  // ========== NEAREST UPCOMING EVENT ==========

  /**
   * Find the nearest future event that hasn't passed
   */
  function getNearestUpcomingKey(events) {
    const now = new Date();
    let best = null;

    events.forEach((ev) => {
      const statusInfo = calculateEventStatus(ev);
      if (
      statusInfo.status === 'PAST' ||
      statusInfo.status === 'ONGOING'
    ) {
      return;
    }
      const dateStr = ev._iso || ev.date || '';
      const d = new Date(dateStr);
      if (isNaN(d)) return;

      // For events with times, use start time
      if (ev.startTime) {
        const [hours, minutes] = ev.startTime.split(':').map(Number);
        d.setHours(hours, minutes, 0, 0);
      }else {
      d.setHours(0, 0, 0, 0);
      }

      const key = makeEventKey(ev);
      if (!key) return;

      if (!best || d < best.date) {
        best = { key, date: d };
      }
    });

    return best ? best.key : null;
  }

  // ========== BROWSER NOTIFICATIONS ==========

  /*
   * Request notification permission if not already granted
   */
  function requestNotificationPermission() {
    if (!('Notification' in window)) return;
    if (Notification.permission === 'default') {
      Notification.requestPermission();
    }
  }

  /**
   * Try to send notification for upcoming event
   */
  function tryNotifyEvent(event) {
    if (!('Notification' in window)) return;
    if (Notification.permission !== 'granted') return;

    const key = makeEventKey(event);
    if (notifiedEvents.has(key)) return;

    const statusInfo = calculateEventStatus(event);
    const now = new Date();
    const dateStr = event._iso || event.date || '';
    const eventDate = new Date(dateStr);

    if (event.startTime && !isNaN(eventDate)) {
      const [hours, minutes] = event.startTime.split(':').map(Number);
      const startDateTime = new Date(eventDate);
      startDateTime.setHours(hours, minutes, 0, 0);

      const msUntilStart = startDateTime - now;

      // Notify 15 minutes before
      if (msUntilStart > 0 && msUntilStart <= CONFIG.notificationLeadTime) {
        try {
          new Notification('Event Starting Soon!', {
            body: `${event.title} starts at ${formatTime12Hour(event.startTime)}`,
            icon: event.image || './favicon.png',
          });
          notifiedEvents.add(key);
        } catch (err) {
          console.warn('Notification failed:', err);
        }
      }
    }
  }





  // ========== LOAD EVENTS ==========

  async function loadEvents() {
    try {
      const res = await fetch(CONFIG.eventsPath);
      allEvents = await res.json();

      // Normalize data
      allEvents = allEvents.map((ev) => {
        if (!ev.tags) ev.tags = [];
        if (!ev.keywords) ev.keywords = '';
        if (ev.date && typeof ev.date === 'string') {
          ev._iso = isoDateSafe(ev.date);
        } else {
          ev._iso = ev.date || '';
        }
        return ev;
      });

      // Compute nearest upcoming
      nearestUpcomingKey = getNearestUpcomingKey(allEvents);

      //  Initialize runtime flags
      allEvents.forEach(ev => {
        ev._toastShown = false;
      });

      allEvents.forEach(ev => {
        if (!ev.startTime) return;

       const statusInfo = calculateEventStatus(ev);
        if (statusInfo.status === 'PAST') return; // Skip past events
        
        const eventKey = `event-meta-${ev.id || makeEventKey(ev)}`;
        
        localStorage.setItem(
          eventKey,
          JSON.stringify({
            id: ev.id || makeEventKey(ev),
            title: ev.title,
            date: ev._iso || ev.date,
            startTime: ev.startTime,
          })
        );
      });


      renderEvents(allEvents);
      injectJSONLD();

      // Request notification permission
     // requestNotificationPermission();

      // Start auto-refresh
      startAutoRefresh();
    } catch (err) {
      console.error('Failed to load events', err);
      if (container) {
        container.innerHTML =
          '<div class="text-center py-12"><h3>Error loading events</h3><p>Please try again later.</p></div>';
      }
    }
  }

  // ========== AUTO REFRESH SYSTEM ==========

  function startAutoRefresh() {
  if (refreshTimer) clearInterval(refreshTimer);

  refreshTimer = setInterval(() => {
    nearestUpcomingKey = getNearestUpcomingKey(allEvents);

    allEvents.forEach((event) => {
      const statusInfo = calculateEventStatus(event);

      

    });

    renderEvents(allEvents);
  }, CONFIG.refreshInterval);
}


  // ========== SEARCH & FILTER ==========

  function matchesSearch(event, query) {
    if (!query) return true;
    const q = query.trim().toLowerCase();
    return (
      (event.title && event.title.toLowerCase().includes(q)) ||
      (event.type && event.type.toLowerCase().includes(q)) ||
      (event.location && event.location.toLowerCase().includes(q)) ||
      (event.organization && event.organization.toLowerCase().includes(q)) ||
      (event.description && event.description.toLowerCase().includes(q)) ||
      (event.tags && event.tags.join(' ').toLowerCase().includes(q)) ||
      (event.keywords && event.keywords.toLowerCase().includes(q))
    );
  }

  // ========== RENDER EVENTS ==========

  function renderEvents(list) {
    if (!container) return;

    const q = searchInput && searchInput.value ? searchInput.value : '';

    // Filter by active tab + search
    let filtered = list.filter((ev) => {
      const statusInfo = calculateEventStatus(ev);

      let passStatus = true;
      if (activeFilter === 'upcoming') {
        passStatus = statusInfo.status !== 'PAST';
      } else if (
        ['workshop', 'conference', 'guest-lecture', 'training', 'book-event'].includes(
          activeFilter
        )
      ) {
        passStatus = (ev.type || '').toLowerCase() === activeFilter;
      }

      return passStatus && matchesSearch(ev, q);
    });

    // Sort: upcoming ascending, past descending
      filtered.sort((a, b) => {
        const sa = calculateEventStatus(a);
        const sb = calculateEventStatus(b);

        const pa = STATUS_PRIORITY[sa.status] || 99;
        const pb = STATUS_PRIORITY[sb.status] || 99;

        // 1Ô∏è‚É£ Primary: status priority
        if (pa !== pb) {
          return pa - pb;
        }

        // 2Ô∏è‚É£ Secondary: actual start datetime
        const da = new Date(a._iso || a.date);
        const db = new Date(b._iso || b.date);

        if (a.startTime) {
          const [ha, ma] = a.startTime.split(':').map(Number);
          da.setHours(ha, ma, 0, 0);
        } else {
          da.setHours(0, 0, 0, 0);
        }

        if (b.startTime) {
          const [hb, mb] = b.startTime.split(':').map(Number);
          db.setHours(hb, mb, 0, 0);
        } else {
          db.setHours(0, 0, 0, 0);
        }

        // üîÅ SPECIAL CASE: PAST EVENTS ‚Üí DESCENDING
        if (sa.status === 'PAST' && sb.status === 'PAST') {
          return db - da; // newest past first
        }

        // ‚úÖ All other statuses ‚Üí ASCENDING
        return da - db;
      });




    // Empty state
    if (filtered.length === 0) {
      container.innerHTML =
        '<div class="col-span-3 text-center py-12"><div class="text-gray-400 text-6xl mb-4">üìÖ</div><h3 class="text-xl font-bold mb-2">No matching events</h3><p class="text-gray-600">Try changing filters or clearing the search field.</p></div>';
      return;
    }

    // Render cards
    container.innerHTML = filtered
      .map((ev) => {
        const statusInfo = calculateEventStatus(ev);
        const key = makeEventKey(ev);
        const isHighlighted = nearestUpcomingKey && key === nearestUpcomingKey;

        const shortDesc =
          ev.description && ev.description.length > 220
            ? ev.description.slice(0, 220) + '‚Ä¶'
            : ev.description || '';

        const tagsHtml = (ev.tags || [])
          .map((t) => `<span class="event-tag">${t}</span>`)
          .join(' ');

        // Register button logic
        const rawRegLink =
          typeof ev.registerLink === 'string' ? ev.registerLink.trim() : '';
        const hasRegLink = rawRegLink.length > 0;

        const deadlineStr = ev.registrationDeadline || ev.registrationEnd || ev.regDeadline || '';
        let canRegister = false;

        if (hasRegLink && statusInfo.status !== 'PAST') {
          if (deadlineStr) {
            const deadlineDate = new Date(deadlineStr);
            if (!isNaN(deadlineDate)) {
              canRegister = deadlineDate >= new Date();
            } else {
              canRegister = true;
            }
          } else {
            canRegister = true;
          }
        }

        // Escape for inline JS
        const safeTitle = (ev.title || '').replace(/'/g, "\\'");
        const safeDesc = (ev.description || '').replace(/'/g, "\\'");
        const safeLoc = (ev.location || '').replace(/'/g, "\\'");
        const safeImage = (ev.image || '').replace(/'/g, "\\'");
        const typeLabel = esc((ev.type || 'Event').replace(/-/g, ' '));

        // Poster link
        const hasPoster = !!ev.image;
        const posterLinkHtml = hasPoster
          ? `<div class="event-card__poster mb-3">
               <button type="button" class="event-card__poster-link"
                 onclick="openPosterModal('${safeTitle}', '${safeImage}', '${ev.id || ''}')">
                 <span class="event-card__poster-icon" aria-hidden="true">üñº</span>
                 <span>View event poster</span>
               </button>
             </div>`
          : '';

        // Action buttons
        let actionButtonsHtml = '';

        if (statusInfo.status !== 'PAST') {
          if (canRegister) {
            actionButtonsHtml += `<a class="btn-primary text-sm px-4 py-2" href="${rawRegLink}" target="_blank" rel="noopener">Register Now</a>`;
          } else if (hasRegLink) {
            actionButtonsHtml += `<span class="btn-secondary text-sm px-4 py-2 opacity-60 cursor-not-allowed">Registration closed</span>`;
          }

          actionButtonsHtml += `<button class="btn-secondary text-sm px-4 py-2" 
            onclick="addToGoogleCalendar('${safeTitle}','${ev._iso || ev.date || ''}','${safeLoc}','${safeDesc}',${
            ev.dateApprox ? 'true' : 'false'
          },'${ev.startTime || ''}','${ev.endTime || ''}')">Add to Google Calendar</button>`;
        } else {
          actionButtonsHtml = `<span class="btn-secondary text-sm px-4 py-2 opacity-50 cursor-not-allowed">Event Completed</span>`;
        }

        // Time display (only for TODAY, STARTING_SOON, ONGOING)
        let timeDisplay = '';
        if (statusInfo.showTime && ev.startTime) {
          timeDisplay = `<div class="event-time">${formatTime12Hour(ev.startTime)}</div>`;
        }

        // Countdown display
        let countdownDisplay = '';
        if (statusInfo.countdown) {
          countdownDisplay = `<div class="event-countdown">${statusInfo.countdown}</div>`;
        }

        return `
          <article class="card card--event ${isHighlighted ? 'card--event--upcoming' : ''}">
            <div class="p-5">
              <div class="flex justify-between items-start mb-3">
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold ${statusInfo.statusClass}">
                    ${statusInfo.statusLabel}
                  </span>
                  <span class="card__badge">${typeLabel}</span>
                </div>
                <time class="text-sm text-gray-500" datetime="${ev._iso || ''}">
                  ${formatDateFriendly(ev._iso || ev.date)}
                </time>
              </div>

              ${isHighlighted ? '<div class="flex flex-col items-end gap-1 mb-2"><span class="event-badge-next" aria-label="Nearest upcoming event">Next event</span></div>' : ''}

              ${timeDisplay}
              ${countdownDisplay}

              <h3 class="text-xl font-bold mb-2">${ev.title}</h3>
              <p class="text-gray-600 mb-3">${shortDesc}</p>

              <div class="flex items-center text-gray-500 mb-4">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21h18M3 10h18M5 6h14M7 2h10M4 14h16M6 18h12"></path>
                </svg>
                <span class="text-sm">${ev.organization || 'Organized by host institution'}</span>
              </div>

              <div class="flex items-center text-gray-500 mb-4">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span class="text-sm">${ev.location || 'Online'}</span>
              </div>

              <div class="flex gap-2 flex-wrap mb-3">${tagsHtml}</div>
              ${posterLinkHtml}
              <div class="flex flex-wrap gap-2">${actionButtonsHtml}</div>
            </div>
          </article>
        `;
      })
      .join('');
  }

  // ========== CONTROLS ==========

  function initControls() {
    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.filter-btn').forEach((b) => b.setAttribute('aria-pressed', 'false'));
        btn.setAttribute('aria-pressed', 'true');
        activeFilter = btn.getAttribute('data-filter') || 'all';
        renderEvents(allEvents);
      });
    });

    // Search input
    if (searchInput) {
      searchInput.addEventListener('input', () => renderEvents(allEvents));
    }
  }

  // ========== GOOGLE CALENDAR ==========

  function openCalendarUrl(url) {
    const win = window.open(url, '_blank', 'noopener');
    if (!win) {
      window.location.href = url;
    }
  }

  window.addToGoogleCalendar = function (
    title,
    dateISO,
    location,
    description,
    dateApprox,
    startTime,
    endTime
  ) {
    const text = encodeURIComponent(title || '');
    const loc = encodeURIComponent(location || '');
    const details = encodeURIComponent(description || '');

    const cleanDate = (dateISO || '').split('T')[0];
    let baseDate = cleanDate ? new Date(cleanDate) : new Date();
    if (isNaN(baseDate)) baseDate = new Date();

    // All-day event helper
    function buildAllDayUrl(d) {
      const startStr = d.toISOString().split('T')[0].replace(/-/g, '');
      const end = new Date(d.getTime());
      end.setDate(end.getDate() + 1);
      const endStr = end.toISOString().split('T')[0].replace(/-/g, '');
      return `https://www.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${startStr}/${endStr}&location=${loc}&details=${details}`;
    }

    // If approximate or no time, use all-day
    if (dateApprox || !startTime) {
      openCalendarUrl(buildAllDayUrl(baseDate));
      return;
    }

    // Build timed event
    const [startHours, startMinutes] = startTime.split(':').map(Number);
    const startLocal = new Date(cleanDate);
    startLocal.setHours(startHours, startMinutes, 0, 0);

    let endLocal;
    if (endTime) {
      const [endHours, endMinutes] = endTime.split(':').map(Number);
      endLocal = new Date(cleanDate);
      endLocal.setHours(endHours, endMinutes, 0, 0);
    } else {
      endLocal = new Date(startLocal.getTime() + 2 * 60 * 60 * 1000);
    }

    function toGCal(dt) {
      return dt.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    }

    const startStr = toGCal(startLocal);
    const endStr = toGCal(endLocal);
    const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${startStr}/${endStr}&location=${loc}&details=${details}`;
    openCalendarUrl(url);
  };

  // ========== POSTER MODAL ==========

  window.openPosterModal = function (title, imageUrl, eventId) {
    if (!imageUrl) return;

    const modal = document.getElementById('posterModal');
    if (!modal) {
      window.open(imageUrl, '_blank', 'noopener');
      trackPosterClick(eventId, title, imageUrl);
      return;
    }

    const img = modal.querySelector('.poster-modal__img');
    const caption = modal.querySelector('.poster-modal__caption');

    img.src = imageUrl;
    img.alt = title + ' ‚Äì event poster';
    caption.textContent = title;

    modal.classList.add('poster-modal--open');
    modal.setAttribute('aria-hidden', 'false');

    trackPosterClick(eventId, title, imageUrl);
  };

  window.closePosterModal = function () {
    const modal = document.getElementById('posterModal');
    if (!modal) return;
    const img = modal.querySelector('.poster-modal__img');
    img.src = '';
    modal.classList.remove('poster-modal--open');
    modal.setAttribute('aria-hidden', 'true');
  };

  window.trackPosterClick = function (eventId, title, imageUrl) {
    console.log('Poster click', { eventId, title, imageUrl });

    if (typeof gtag === 'function') {
      gtag('event', 'poster_click', {
        event_category: 'engagement',
        event_label: title,
        event_id: eventId || null,
        poster_url: imageUrl,
      });
    }

    if (window.dataLayer && Array.isArray(window.dataLayer)) {
      window.dataLayer.push({
        event: 'poster_click',
        event_id: eventId || null,
        event_title: title,
        poster_url: imageUrl,
      });
    }
  };

  // Close modal on ESC
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
      window.closePosterModal();
    }
  });

  // ========== JSON-LD INJECTION ==========

  function injectJSONLD() {
    const upcoming = allEvents
      .filter((e) => {
        const statusInfo = calculateEventStatus(e);
        return statusInfo.status !== 'PAST';
      })
      .slice(0, 20);

    if (upcoming.length === 0) return;

    const graph = upcoming.map((ev) => ({
      '@context': 'https://schema.org',
      '@type': 'Event',
      name: ev.title,
      startDate: ev._iso || ev.date,
      location: {
        '@type': 'Place',
        name: ev.location || ev.organization || 'Online',
      },
      description: ev.description || '',
      organizer: {
        '@type': 'Organization',
        name: ev.organization || '',
      },
      url: ev.registerLink || window.location.href,
    }));

    const ld = document.createElement('script');
    ld.type = 'application/ld+json';
    ld.text = JSON.stringify(graph);
    document.head.appendChild(ld);
  }

  // ========== INITIALIZATION ==========

  document.addEventListener('DOMContentLoaded', () => {
    initControls();
    loadEvents();
  });

  // Expose render for debugging
  window._renderEvents = () => renderEvents(allEvents);

  // Clean up on page unload
  window.addEventListener('beforeunload', () => {
    if (refreshTimer) {
      clearInterval(refreshTimer);
    }
  });
})();
    </script>


    <!-- Keep your core theme + mobile nav JS -->
    <script src="./js/ui.js"></script>
  </body>
</html>
